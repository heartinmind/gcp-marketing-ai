# Cloud Build CI/CD íŒŒì´í”„ë¼ì¸
# Google Cloud Build ì„¤ì •

steps:
  # 1. í™˜ê²½ ì„¤ì •
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ MarketingAI CI/CD íŒŒì´í”„ë¼ì¸ ì‹œì‘"
        python --version
        pip --version

  # 2. ì˜ì¡´ì„± ì„¤ì¹˜
  - name: 'python:3.9'
    entrypoint: 'pip'
    args: ['install', '-r', 'requirements.txt']
    dir: '.'

  # 3. ì •ì  íƒ€ì… ì²´í¬ (ruff)
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install ruff
        echo "ğŸ” Ruff ì •ì  ë¶„ì„ ì‹¤í–‰..."
        ruff check . --output-format=github
        echo "âœ… Ruff ë¶„ì„ ì™„ë£Œ"
    id: 'ruff-check'

  # 4. íƒ€ì… ì²´í¬ (mypy)
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install mypy
        echo "ğŸ” MyPy íƒ€ì… ì²´í¬ ì‹¤í–‰..."
        mypy --ignore-missing-imports api/ || echo "âš ï¸ MyPy ê²½ê³  ìˆìŒ"
        echo "âœ… MyPy ì²´í¬ ì™„ë£Œ"
    id: 'mypy-check'

  # 5. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install pytest pytest-cov
        echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        pytest tests/ -v --cov=. --cov-report=term-missing || echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
    id: 'unit-tests'

  # 6. API ì„œë²„ Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/marketing-ai-api:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/marketing-ai-api:latest'
      - '-f'
      - 'Dockerfile.api'
      - '.'
    id: 'build-api'

  # 7. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags', 'gcr.io/$PROJECT_ID/marketing-ai-api']
    id: 'push-api'

  # 8. Terraform ê³„íš (ì¸í”„ë¼ ë³€ê²½ì‚¬í•­ í™•ì¸)
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd infra
        terraform init
        terraform plan -var="project_id=$PROJECT_ID" -out=tfplan
        echo "âœ… Terraform ê³„íš ì™„ë£Œ"
    id: 'terraform-plan'

  # 9. Terraform ì ìš© (main ë¸Œëœì¹˜ë§Œ)
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd infra
        if [ "$BRANCH_NAME" = "main" ]; then
          echo "ğŸš€ í”„ë¡œë•ì…˜ ì¸í”„ë¼ ë°°í¬ ì‹¤í–‰..."
          terraform apply -auto-approve tfplan
          echo "âœ… ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ"
        else
          echo "â„¹ï¸ main ë¸Œëœì¹˜ê°€ ì•„ë‹ˆë¯€ë¡œ Terraform ì ìš© ê±´ë„ˆëœ€"
        fi
    id: 'terraform-apply'

  # 10. Cloud Runì— API ë°°í¬
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'marketing-ai-api-dev'
      - '--image'
      - 'gcr.io/$PROJECT_ID/marketing-ai-api:$COMMIT_SHA'
      - '--region'
      - 'us-central1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-env-vars'
      - 'PROJECT_ID=$PROJECT_ID,ENVIRONMENT=dev'
    id: 'deploy-api'

  # 11. ML íŒŒì´í”„ë¼ì¸ ì»´íŒŒì¼ ë° ì—…ë¡œë“œ
  - name: 'python:3.9'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install kfp google-cloud-aiplatform
        echo "ğŸ¤– ML íŒŒì´í”„ë¼ì¸ ì»´íŒŒì¼..."
        cd ml/training
        python -c "
        from pipeline import marketing_ai_training_pipeline
        from kfp import compiler
        compiler.Compiler().compile(
            pipeline_func=marketing_ai_training_pipeline,
            package_path='marketing_ai_pipeline.json'
        )
        print('âœ… ML íŒŒì´í”„ë¼ì¸ ì»´íŒŒì¼ ì™„ë£Œ')
        "
        echo "ğŸ“¤ íŒŒì´í”„ë¼ì¸ Cloud Storage ì—…ë¡œë“œ..."
        gsutil cp marketing_ai_pipeline.json gs://$PROJECT_ID-marketing-ai-datalake-dev/pipelines/
    id: 'ml-pipeline'

  # 12. ëŒ€ì‹œë³´ë“œ ë°°í¬ (Cloud Run)
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/marketing-ai-dashboard:$COMMIT_SHA'
      - '-f'
      - 'Dockerfile.dashboard'
      - '.'
    id: 'build-dashboard'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/marketing-ai-dashboard:$COMMIT_SHA']
    id: 'push-dashboard'

  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'marketing-ai-dashboard-dev'
      - '--image'
      - 'gcr.io/$PROJECT_ID/marketing-ai-dashboard:$COMMIT_SHA'
      - '--region'
      - 'us-central1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8501'
    id: 'deploy-dashboard'

  # 13. ë°°í¬ ì•Œë¦¼
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ‰ MarketingAI ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ“Š ëŒ€ì‹œë³´ë“œ: https://marketing-ai-dashboard-dev-$PROJECT_ID.a.run.app"
        echo "ğŸ”Œ API: https://marketing-ai-api-dev-$PROJECT_ID.a.run.app"
        echo "ğŸ“ˆ íŒŒì´í”„ë¼ì¸ ìœ„ì¹˜: gs://$PROJECT_ID-marketing-ai-datalake-dev/pipelines/"

# ë¹Œë“œ ì˜µì…˜
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# ë¹Œë“œ íŠ¸ë¦¬ê±° ì„¤ì •
timeout: '3600s'  # 1ì‹œê°„

# í™˜ê²½ ë³€ìˆ˜
substitutions:
  _ENVIRONMENT: 'dev'

# IAM ê¶Œí•œ
serviceAccount: 'projects/$PROJECT_ID/serviceAccounts/cloudbuild@$PROJECT_ID.iam.gserviceaccount.com' 